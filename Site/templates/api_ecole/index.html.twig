{% extends 'base.html.twig' %}

{% block title %}Gestion des Écoles - API{% endblock %}

{% block body %}
<div class="container mt-4">
    <h1>Gestion des Écoles via API JavaEE</h1>
    
    <!-- Formulaire de création -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>Créer une nouvelle école</h5>
        </div>
        <div class="card-body">
            <form id="createEcoleForm">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="nom" class="form-label">Nom de l'école *</label>
                            <input type="text" class="form-control" id="nom" name="nom" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="adresse" class="form-label">Adresse *</label>
                            <input type="text" class="form-control" id="adresse" name="adresse" required>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="ville" class="form-label">Ville *</label>
                            <input type="text" class="form-control" id="ville" name="ville" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="codePostal" class="form-label">Code Postal *</label>
                            <input type="text" class="form-control" id="codePostal" name="codePostal" required>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Créer l'école</button>
            </form>
        </div>
    </div>

    <!-- Liste des écoles -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5>Liste des écoles</h5>
            <button class="btn btn-outline-primary btn-sm" onclick="loadEcoles()">Actualiser</button>
        </div>
        <div class="card-body">
            <div id="ecolesList">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour modifier une école -->
<div class="modal fade" id="editEcoleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modifier l'école</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editEcoleForm">
                    <input type="hidden" id="editId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editNom" class="form-label">Nom de l'école *</label>
                                <input type="text" class="form-control" id="editNom" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editAdresse" class="form-label">Adresse *</label>
                                <input type="text" class="form-control" id="editAdresse" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editVille" class="form-label">Ville *</label>
                                <input type="text" class="form-control" id="editVille" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editCodePostal" class="form-label">Code Postal *</label>
                                <input type="text" class="form-control" id="editCodePostal" required>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="updateEcole()">Sauvegarder</button>
            </div>
        </div>
    </div>
</div>

<script>
// Charger les écoles au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    loadEcoles();
});

// Formulaire de création
document.getElementById('createEcoleForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = {
        nom: document.getElementById('nom').value,
        adresse: document.getElementById('adresse').value,
        ville: document.getElementById('ville').value,
        codePostal: document.getElementById('codePostal').value
    };
    
    fetch('/api/ecoles', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Erreur: ' + data.error);
        } else {
            alert('École créée avec succès!');
            document.getElementById('createEcoleForm').reset();
            loadEcoles();
        }
    })
    .catch(error => {
        alert('Erreur lors de la création: ' + error);
    });
});

// Charger la liste des écoles
function loadEcoles() {
    fetch('/api/ecoles')
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('ecolesList');
        
        if (data.error) {
            container.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
            return;
        }
        
        if (data.length === 0) {
            container.innerHTML = '<p class="text-muted">Aucune école trouvée.</p>';
            return;
        }
        
        let html = '<div class="table-responsive"><table class="table table-striped">';
        html += '<thead><tr><th>ID</th><th>Nom</th><th>Adresse</th><th>Ville</th><th>Code Postal</th><th>Actions</th></tr></thead><tbody>';
        
        data.forEach(ecole => {
            html += `
                <tr>
                    <td>${ecole.id}</td>
                    <td>${ecole.nom}</td>
                    <td>${ecole.adresse}</td>
                    <td>${ecole.ville || '-'}</td>
                    <td>${ecole.codePostal || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editEcole(${ecole.id}, '${ecole.nom}', '${ecole.adresse}', '${ecole.ville || ''}', '${ecole.codePostal || ''}')">
                            Modifier
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteEcole(${ecole.id})">
                            Supprimer
                        </button>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
        container.innerHTML = html;
    })
    .catch(error => {
        document.getElementById('ecolesList').innerHTML = 
            `<div class="alert alert-danger">Erreur lors du chargement: ${error}</div>`;
    });
}

// Modifier une école
function editEcole(id, nom, adresse, ville, codePostal) {
    document.getElementById('editId').value = id;
    document.getElementById('editNom').value = nom;
    document.getElementById('editAdresse').value = adresse;
    document.getElementById('editVille').value = ville;
    document.getElementById('editCodePostal').value = codePostal;
    
    new bootstrap.Modal(document.getElementById('editEcoleModal')).show();
}

// Mettre à jour une école
function updateEcole() {
    const id = document.getElementById('editId').value;
    const formData = {
        nom: document.getElementById('editNom').value,
        adresse: document.getElementById('editAdresse').value,
        ville: document.getElementById('editVille').value,
        codePostal: document.getElementById('editCodePostal').value
    };
    
    fetch(`/api/ecoles/${id}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Erreur: ' + data.error);
        } else {
            alert('École mise à jour avec succès!');
            bootstrap.Modal.getInstance(document.getElementById('editEcoleModal')).hide();
            loadEcoles();
        }
    })
    .catch(error => {
        alert('Erreur lors de la mise à jour: ' + error);
    });
}

// Supprimer une école
function deleteEcole(id) {
    if (confirm('Êtes-vous sûr de vouloir supprimer cette école?')) {
        fetch(`/api/ecoles/${id}`, {
            method: 'DELETE'
        })
        .then(response => {
            if (response.ok) {
                alert('École supprimée avec succès!');
                loadEcoles();
            } else {
                return response.json().then(data => {
                    alert('Erreur: ' + (data.error || 'Erreur lors de la suppression'));
                });
            }
        })
        .catch(error => {
            alert('Erreur lors de la suppression: ' + error);
        });
    }
}
</script>
{% endblock %} 